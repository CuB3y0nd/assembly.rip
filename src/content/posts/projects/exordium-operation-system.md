---
title: "Exordium Operating System Development Notes"
published: 2025-03-09
updated: 2025-03-17
description: "Exordium operating system development notes. Mainly based on the bookã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹"
tags: ["Operating System", "Notes"]
category: "Operating System"
draft: false
---

# å‰è¨€

ä¸ºäº†æå‡å¼€å‘æ°´å¹³å’Œå·¥ç¨‹èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æ·±å…¥å­¦ä¹  C è¯­è¨€â€¦â€¦æˆ‘å†æ¬¡æ‹¾èµ·äº†è¿™é¡¹è‰°å·¨å´è®©æˆ‘æ— æ¯”å‘å¾€çš„é¡¹ç›®<s>_ï¼ˆç§å­æ—©åœ¨ä¸¤å¹´å‰å°±ç§ä¸‹äº†ï¼Œç°åœ¨æ‰å¼€å§‹ç”Ÿé•¿ï¼Œè¯·å«æˆ‘æ‘†çƒ‚ Masterï¼‰_</s>ã€‚

è¯è¯´ä»Šå¹´ï¼ˆç¡®åˆ‡çš„è¯´åº”è¯¥æ˜¯æˆªè‡³ä¹æœˆä¸­æ—¬ï¼‰æˆ‘ä¸»è¦åŠŸå¤«éƒ½ä¼šå€¾æ³¨åœ¨å­¦ä¸šä¸­ï¼Œè¿™æ„å‘³ç€ï¼Œæˆ‘èƒ½æŠ•èº«äºæŠ€æœ¯æ¢ç´¢çš„æ—¶é—´å°†å˜å¾—ç¨€ç¼ºï¼ˆè¿™æ€ä¹ˆè¡Œï¼Œæˆ‘æ€ä¹ˆèƒ½åŸåœ°è¸æ­¥ï¼æ‰€ä»¥ï¼Œå³ä¾¿å½“å‰ä»¥å­¦ä¸šä¸ºä¸»ï¼Œæˆ‘ä¹Ÿæ‰“ç®—åœ¨è¿™æ®µæ—¶é—´é¡ºä¾¿ç§¯æ·€ä¸€ä¸‹è‡ªå·±çš„ç¡¬å®åŠ›ã€‚å¾…åˆ°å›å½’ä¹‹æ—¥ï¼Œåˆæ˜¯ä¸€ä¸ªæ›´å“‡å¡çš„è‡ªå·±ï½ï¼‰â€¦â€¦

å€Ÿå£ï¼Ÿæˆ–è®¸å§â€¦â€¦åˆšå¼€å­¦å‰ä¸¤å‘¨ç»å—äº†ä¸€ä¸ªã€Œå°å°çš„ã€æŒ«æŠ˜ï¼Œè®©æˆ‘æœ‰ã€Œä¸€ç‚¹ç‚¹ã€å´©ã€‚å”‰ï¼Œè¯´å¤šäº†éƒ½æ˜¯æ³ªâ€¦â€¦æ²¡æ­»å°±å¥½ LOL

ä¸»è¦å‚è€ƒä¹¦ç±æ˜¯**_ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹_**ï¼Œè¿™æœ¬ä¹¦ä½“é‡å’Œ **_CSAPP_** æœ‰ä¸€æ‹¼â€¦â€¦

è®°å½•ä¸€ä¸‹ï¼Œæˆ‘æ˜¯ä» _03/09/2025_ æ­£å¼å¼€å§‹çš„ï¼Œ<s>è™½ç„¶è¿˜æ²¡å†™ä¸‹ä»»ä½•ä¸€è¡Œä»£ç ï¼Œä½†å‡†ç¡®æ¥è¯´å°±æ˜¯è¿™ä¸ªç‚¹â€¦â€¦</s>åªæ˜¯æƒ³åœ¨æœ€åçœ‹çœ‹ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œå±Šæ—¶å¯èƒ½ä¼šå°å°çš„æ„Ÿæ…¨ä¸€ä¸‹ä¸‹å§ã€‚

::github{repo="CuB3y0nd/Exordium"}

<br />

# è®¡ç®—æœºå¯åŠ¨è¿‡ç¨‹

## å®æ¨¡å¼ä¸‹çš„ 1MB å†…å­˜å¸ƒå±€

ä¸ºä½•æ˜¯ 1MBï¼Ÿè¿™å¾—è¿½æº¯åˆ° Intel 8086 çš„æ—¶ä»£äº†ã€‚é‚£æ—¶å€™ Intel 8086 åªæœ‰ 20 æ ¹åœ°å€æ€»çº¿ï¼Œæ•…å…¶åªèƒ½è®¿é—® $$2^{20} =1048576$$ å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 1MB çš„å†…å­˜ç©ºé—´ï¼Œè€Œè¿™ 1MB åˆè¢«æ‹†ä¸ºå¤šä¸ªéƒ¨åˆ†åˆ†åˆ«ç”¨äºä¸åŒçš„ç”¨é€”ã€‚

å®æ¨¡å¼ä¸‹çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š

| èµ·å§‹    | ç»“æŸ    | å¤§å°              | ç”¨é€”                                                                                                                                             |
| ------- | ------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| 0xFFFF0 | 0xFFFFF | 16B               | BIOS å…¥å£åœ°å€ï¼Œæ­¤åœ°å€ä¹Ÿå±äº BIOS ä»£ç ï¼ŒåŒæ ·å±äºé¡¶éƒ¨çš„ 64KB å­—èŠ‚ã€‚åªæ˜¯ä¸ºäº†å¼ºè°ƒå…¶å…¥å£åœ°å€æ‰å•ç‹¬è´´å‡ºæ¥ã€‚æ­¤å¤„ 16 å­—èŠ‚çš„å†…å®¹æ˜¯è·³è½¬æŒ‡ä»¤ jmp F000\:E05B |
| 0xF0000 | 0xFFFEF | 64KB-16B          | ç³»ç»Ÿ BIOS èŒƒå›´æ˜¯ F0000\~FFFFF å…± 64Bï¼Œä¸ºäº†è¯´æ˜å…¥å£åœ°å€ï¼Œå°†æœ€ä¸Šé¢çš„ 16 å­—èŠ‚ä»æ­¤å¤„å»æ‰äº†ï¼Œæ‰€ä»¥æ­¤å¤„ç»ˆæ­¢åœ°å€æ˜¯ 0xFFFEF                               |
| 0xC8000 | 0xEFFFF | 160KB             | æ˜ å°„ç¡¬ä»¶é€‚é…å™¨çš„ ROM æˆ–å†…å­˜æ˜ å°„å¼ I/O                                                                                                            |
| 0xC0000 | 0xC7FFF | 32KB              | æ˜¾ç¤ºé€‚é…å™¨ BIOS                                                                                                                                  |
| 0xB8000 | 0xBFFFF | 32KB              | ç”¨äºæ–‡æœ¬æ¨¡å¼æ˜¾ç¤ºé€‚é…å™¨                                                                                                                           |
| 0xB0000 | 0xB7FFF | 32KB              | ç”¨äºé»‘ç™½æ˜¾ç¤ºé€‚é…å™¨                                                                                                                               |
| 0xA0000 | 0xAFFFF | 64KB              | ç”¨äºå½©è‰²æ˜¾ç¤ºé€‚é…å™¨                                                                                                                               |
| 0x9FC00 | 0x9FFFF | 1KB               | EDBA (Extended BIOS Data Area)                                                                                                                   |
| 0x7E00  | 0x9FBFF | 622080Bï¼Œçº¦ 608KB | å¯ç”¨åŒºåŸŸ                                                                                                                                         |
| 0x7C00  | 0x7DFF  | 512B              | MBR è¢« BIOS åŠ è½½åˆ°æ­¤å¤„                                                                                                                           |
| 0x0500  | 0x7BFF  | 30464Bï¼Œçº¦ 30KB   | å¯ç”¨åŒºåŸŸ                                                                                                                                         |
| 0x0400  | 0x04FF  | 256B              | BIOS Data Area                                                                                                                                   |
| 0x00    | 0x03FF  | 1KB               | Interrupt Vector Table                                                                                                                           |

## è®¡ç®—æœºçš„å¯åŠ¨è¿‡ç¨‹

å½“æŒ‰ä¸‹ä¸»æœºä¸Šçš„ Power é”®åï¼ŒCPU çš„ CS\:IP è¢«å¼ºåˆ¶åˆå§‹åŒ–ä¸º 0xF000\:0xFFF0ã€‚ç”±äºåˆšå¼€æœºæ—¶å¤„äºå®æ¨¡å¼ï¼Œæ•…æ®µéƒ¨ä»¶å°†æ®µåœ°å€å·¦ç§»å››ä½å†åŠ ä¸Šåç§»åœ°å€ï¼Œå¾—åˆ°ç‰©ç†åœ°å€ 0xFFFF0ï¼Œä¹Ÿå°±æ˜¯æ˜¯ BIOS (Basic Input/Output System) çš„å…¥å£åœ°å€ã€‚æ‰€ä»¥ç¬¬ä¸€ä¸ªè¢«è¿è¡Œçš„è½¯ä»¶æ˜¯ BIOS. BIOS ä¸»è¦è´Ÿè´£é€šè¿‡ç¡¬ä»¶æä¾›çš„åŸºæœ¬è°ƒç”¨æ¥æ£€æµ‹ã€åˆå§‹åŒ–ç¡¬ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜å»ºç«‹äº†æœ€åŸºæœ¬çš„ä¸­æ–­å‘é‡è¡¨ (Interrupt Vector Table, IVT)ï¼Œä¹‹æ‰€ä»¥è¯´æ˜¯æœ€åŸºæœ¬ï¼Œæ˜¯å› ä¸º BIOS å°± 64KB å¤§ï¼Œä¸å¯èƒ½æŠŠæ‰€æœ‰çš„ç¡¬ä»¶ I/O æ“ä½œéƒ½å®ç°å¾—é¢é¢ä¿±åˆ°ï¼Œå¹¶ä¸”ä¹Ÿæ²¡å¿…è¦å®ç°é‚£ä¹ˆå¤šï¼Œå› ä¸ºè¿™æ˜¯åœ¨å®æ¨¡å¼ï¼Œå¯¹ç¡¬ä»¶æ”¯æŒçš„å†ä¸°å¯Œä¹Ÿç™½æ­ï¼Œç²¾å½©çš„ä¸–ç•Œæ˜¯ä»è¿›å…¥ä¿æŠ¤æ¨¡å¼åæ‰å¼€å§‹çš„ï¼Œæ‰€ä»¥å®ƒåªæŒ‘äº†ä¸€äº›æœ€é‡è¦çš„ã€ä¿è¯è®¡ç®—æœºèƒ½è¿è¡Œçš„é‚£äº›æœ€åŸºæœ¬çš„ç¡¬ä»¶ I/O æ“ä½œå®ç°ã€‚

> [!TIP]
> å› ä¸º BIOS æ˜¯è®¡ç®—æœºä¸Šç¬¬ä¸€ä¸ªè¿è¡Œçš„è½¯ä»¶ï¼Œæ‰€ä»¥å®ƒä¸å¯èƒ½è‡ªå·±åŠ è½½è‡ªå·±ï¼Œè€Œæ˜¯ç”±åªè¯»å­˜å‚¨å™¨ ROM è¿™ä¸ªç¡¬ä»¶åŠ è½½çš„ã€‚
>
> BIOS å­˜åœ¨äºä¸»æ¿ä¸Šçš„ ROM ä¸­ï¼Œç¡¬ä»¶å°†è¿™ä¸ª ROM çš„åœ°å€æ˜ å°„åˆ°ä½ç«¯ 1MB å†…å­˜çš„é¡¶éƒ¨ï¼Œä¹Ÿå°±æ˜¯ 0xF0000~0xFFFFF å¤„ã€‚

å› ä¸ºå®æ¨¡å¼ä¸‹åªèƒ½è®¿é—®åˆ° 1MB çš„ç©ºé—´ï¼Œè€Œ 0xFFFF0 è· 1MB åªå‰©å¯æ€œçš„ 16 å­—èŠ‚äº†ï¼Œåœ¨è¿™ä¹ˆå°çš„ç©ºé—´é‡Œæˆ‘ä»¬ç€å®åšä¸äº†å¤ªå¤šæ“ä½œï¼Œæ•…åœ¨æ­¤æ”¾çš„æ˜¯ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œé€šè¿‡ `jmp F000:E05B` è·³è½¬åˆ° 0xFE05B å¤„ç»§ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´çœŸæ­£çš„ BIOS ä»£ç æ˜¯ä» 0xFE05B å¼€å§‹çš„ã€‚

æ¥ä¸‹æ¥ BIOS ä¾¿é©¬ä¸åœè¹„åœ°æ£€æµ‹å†…å­˜ã€æ˜¾å¡ç­‰å¤–è®¾ä¿¡æ¯ï¼Œå½“æ‰€æœ‰æ£€æµ‹é€šè¿‡ï¼Œå¹¶åˆå§‹åŒ–å¥½ç¡¬ä»¶åï¼Œä¾¿åœ¨ 0x00~0x03FF å¤„å»ºç«‹ä¸­æ–­å‘é‡è¡¨ï¼Œå¹¶å‘å…¶ä¸­å¡«å†™ä¸­æ–­ä¾‹ç¨‹ã€‚

è®¡ç®—æœºæ‰§è¡Œåˆ°è¿™ä»½ä¸Šï¼ŒBIOS ä¹Ÿå³å°†å®Œæˆå®ƒè¿™çŸ­æš‚çš„ä¸€ç”Ÿçš„ä½¿å‘½äº†ï¼Œå®Œæˆä¹‹åï¼Œå®ƒåˆå°†æ²‰æ²‰ç¡å»ã€‚æƒ³åˆ°è¿™é‡Œï¼Œå¿ƒé‡Œä¸å…ä¸€ä¸å¿§ä¼¤ï¼Œç”šè‡³æœ‰äº›è®¸æŒ½ç•™å®ƒçš„æƒ³æ³•ã€‚å¯æ˜¯ï¼Œè¿™å°±æ˜¯å®ƒçš„ä½¿å‘½ï¼Œå®ƒç”Ÿæ¥è¢«è®¾è®¡æˆè¿™æ ·ï¼Œå®ƒè¿™çŸ­æš‚çš„ä¸€ç”Ÿå·²ç»ä¸ºåäººåˆ›é€ äº†è¶³å¤Ÿçš„ç²¾å½©ã€‚ä½•å†µï¼Œåœ¨ä¸‹ä¸€æ¬¡å¼€æœºæ—¶ï¼ŒBIOS è¿˜ä¼šé‡å¤è¿™æ®µè½®å›ï¼Œå®ƒå¹¶æ²¡æœ‰æ¶ˆå¤±â€¦â€¦å¤šä¹ˆä¼Ÿå¤§å•Šï¼å¥½äº†ï¼Œè®©ä¼¤æ„Ÿåœæ­¢ï¼Œè®©æ¢¦æƒ³å‰è¡Œï¼

BIOS çš„æœ€åä¸€é¡¹å·¥ä½œæ˜¯å»æ ¡éªŒå¯åŠ¨ç›˜ä¸­ä½äº 0 ç›˜ 0 é“ 1 æ‰‡åŒºçš„å†…å®¹ã€‚å¦‚æœæ­¤æ‰‡åŒºæœ«å°¾çš„ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«ä¸º `0x55` å’Œ `0xAA`ï¼ŒBIOS ä¾¿è®¤ä¸ºæ­¤æ‰‡åŒºä¸­å­˜åœ¨å¯æ‰§è¡Œç¨‹åºï¼Œä¹Ÿå°±æ˜¯ä¸»å¼•å¯¼è®°å½• MBR (Main Boot Record)ï¼Œéšå³å°†å…¶åŠ è½½åˆ° 0x7c00 å¤„ï¼Œå¹¶è·³è½¬åˆ°è¯¥åœ°å€ç»§ç»­æ‰§è¡Œã€‚

ä¸ºä»€ä¹ˆä¸€å®šæ˜¯ 0 ç›˜ 0 é“ 1 æ‰‡åŒºï¼Œè€Œä¸æ˜¯å…¶å®ƒåœ°æ–¹ï¼Ÿå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸ºäº†æ–¹ä¾¿ BIOS æ‰¾åˆ° MBRã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ä¸€è§„å®šï¼ŒBIOS å°±åªå¾—å°†æ‰€æœ‰æ£€æµ‹åˆ°çš„å­˜å‚¨è®¾å¤‡ä¸Šçš„çš„æ¯ä¸€ä¸ªå­˜å‚¨å•ä½éƒ½ç¿»ä¸€éï¼ŒæŒ¨ä¸ªå¯¹æ¯”ï¼Œå¦‚æœå‘ç°è¯¥å­˜å‚¨å•ä½çš„æœ€åä¸¤å­—èŠ‚ä¸º 0x55 å’Œ 0xAAï¼Œå°±è®¤ä¸ºå®ƒæ˜¯ MBR. å‡ ç»èŠ±å¼€èŠ±è½ï¼Œæ‰¾åˆ° MBR çš„é‚£ä¸€åˆ»ï¼ŒBIOS æ»¡è„¸ç–²æƒ«åœ°è¯´ï¼šã€Œä½ æ˜¯æˆ‘æ‰¾äº†å¥½ä¹…çš„é‚£ä¸ªäººã€‚ã€MBR æŠ¬èµ·ç»ä¸èµ·å²æœˆç­‰å¾…çš„è„¸ï¼šã€Œéš¾å¾—ä½ è¿˜è®¤å¾—æˆ‘ï¼Œæˆ‘ç­‰ä½ ç­‰çš„èŠ±å„¿éƒ½è°¢äº†ã€‚ã€å…¶å® BIOS çš„å¿ƒå£°æ˜¯ï¼šã€Œçœ‹æˆ‘æ‰‹å¿™è„šä¹±çš„æ ·å­ï¼Œä½ ä»¬è¿™æ˜¯è¦é—¹å“ªæ ·å•Šã€‚å°±è¿™ä¹ˆ 512 å­—èŠ‚çš„å†…å®¹ï¼Œå®³æˆ‘æ‰¾éå…¨ä¸–ç•Œï¼Œæˆ‘ä»¬è¿™æ˜¯åœ¨è·‘æ¥åŠ›èµ›å•Šï¼Œä¸‹ä¸€æ£’çš„é€‰æ‰‹æˆ‘éƒ½ä¸çŸ¥é“åœ¨å“ªé‡Œâ€¦â€¦ä»¥åè®©å®ƒç«™åœ¨å›ºå®šçš„ä½ç½®ç­‰æˆ‘ï¼ã€

ç”±äº 0 ç›˜ 0 é“ 1 æ‰‡åŒºæ˜¯ç£ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼ŒMBR é€‰æ‹©äº†è¿™ä¸ªç¦» BIOS æœ€è¿‘çš„ä½ç½®ç«™å¥½äº†ï¼Œä»æ­¤ä»¥åå†ä¹Ÿä¸ç”¨æ‹…å¿ƒè¢« BIOS éª‚äº†ã€‚

æ€»ä¹‹ï¼Œè®¡ç®—æœºä¸­åˆ°å¤„éƒ½æœ‰å†™æ­»çš„ä¸œè¥¿ï¼Œå„ç§å„æ ·çš„é­”æ•°å±‚å‡ºä¸ç©·ï¼Œ0xAA55 ä¹Ÿæ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œè¿™ä¸ªå°±ä¸è§£é‡Šäº†ï¼Œå½“æˆè§„å®š/åè®®ç†è§£å§â€¦â€¦

è‡³äº 0x7c00 æ˜¯æ€ä¹ˆæ¥çš„ï¼Œå€’æ˜¯å¯ä»¥è§£é‡Šä¸€ä¸‹ã€‚0x7c00 æœ€æ—©å‡ºç°äº 1981 å¹´ 8 æœˆï¼ŒIBM å…¬å¸æ¨å‡ºçš„ä¸ªäººè®¡ç®—æœº PC 5150 çš„ ROM BIOS çš„ INT 19H ä¸­æ–­å¤„ç†ç¨‹åºä¸­ã€‚PC 5150 æ˜¯ä¸–ç•Œä¸Šç¬¬ä¸€å°ä¸ªäººè®¡ç®—æœºï¼Œå®ƒå°±æ˜¯ç°ä»£ x86 ä¸ªäººè®¡ç®—æœºå…¼å®¹æœºçš„ç¥–å…ˆã€‚

ä¸ªäººè®¡ç®—æœºè‚¯å®šè¦è¿è¡Œæ“ä½œç³»ç»Ÿï¼Œåœ¨è¿™å°è®¡ç®—æœºä¸Šï¼Œè¿è¡Œçš„æ“ä½œç³»ç»Ÿæ˜¯ DOS 1.0ã€‚ä¸æ¸…æ¥šæ­¤ç³»ç»Ÿè¦æ±‚çš„æœ€å°å†…å­˜æ˜¯ 16KB è¿˜æ˜¯ 32KBï¼Œåæ­£ PC 5150 BIOS ç ”å‘å›¢é˜Ÿå°±å‡å®šå…¶æ˜¯ 32KB çš„ï¼Œæ‰€ä»¥æ­¤ BIOS æ˜¯æŒ‰ç…§æœ€å°å†…å­˜ 32KB ç ”å‘çš„ã€‚

MBR ä¸æ˜¯éšä¾¿æ”¾åœ¨å“ªé‡Œéƒ½è¡Œçš„ï¼Œé¦–å…ˆå®ƒä¸èƒ½è¦†ç›–å·²æœ‰æ•°æ®ï¼Œå…¶æ¬¡ï¼Œå®ƒè¿˜ä¸èƒ½è¿‡æ—©çš„è¢«å…¶å®ƒæ•°æ®è¦†ç›–ã€‚MBR çš„ä»»åŠ¡æ˜¯åŠ è½½æŸä¸ªç¨‹åºï¼ˆä¸€èˆ¬æ˜¯å†…æ ¸åŠ è½½å™¨ï¼Œå¾ˆå°‘æœ‰ç›´æ¥åŠ è½½å†…æ ¸çš„ï¼‰åˆ°æŒ‡å®šä½ç½®ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤ç»™å®ƒã€‚ä¹‹åï¼ŒMBR å°±æ²¡ç”¨äº†ï¼Œè¢«è¦†ç›–ä¹Ÿæ²¡å…³ç³»ï¼ˆæˆ‘æŒ‡çš„è¦†ç›–æ˜¯è¦†ç›– 0x7c00 å¤„çš„æŒ‡ä»¤ï¼Œå› ä¸º MBR æœ¬èº«ä¹Ÿæ˜¯è¢«åŠ è½½åˆ°é‚£ä¸ªä½ç½®æ‰§è¡Œçš„ï¼Œè€Œéç¡¬ç›˜ä¸Šæ‰€ä¿å­˜çš„ MBRï¼Œè¦†ç›–äº†ç¡¬ç›˜ä¸Šä¿å­˜çš„ MBR ä¸‹æ¬¡å°±ä¸èƒ½å¯åŠ¨äº†ï¼‰ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œå¾—ç¡®ä¿å®ƒçš„å®Œæ•´æ€§ã€‚

é‡ç°ä¸€ä¸‹å½“æ—¶çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼š

8086 CPU è¦æ±‚ 0x00~0x03FF å­˜æ”¾ä¸­æ–­å‘é‡è¡¨ï¼Œæ‰€ä»¥æ­¤å¤„å°±ä¸èƒ½åŠ¨äº†ï¼Œå†é€‰æ–°çš„åœ°æ–¹çœ‹çœ‹ã€‚æŒ‰ DOS 1.0 è¦æ±‚çš„æœ€å°å†…å­˜ 32KB æ¥è¯´ï¼ŒMBR å¸Œæœ›ç»™äººå®¶å°½å¯èƒ½å¤šçš„é¢„ç•™ç©ºé—´ï¼Œè¿™æ ·ä¹Ÿæ˜¯ä¿å…¨è‡ªå·±çš„ä½œæ³•ï¼Œå…å¾—è¢«è¿‡æ—©è¦†ç›–ã€‚æ‰€ä»¥ MBR åªèƒ½æ”¾åœ¨ 32KB çš„æœ«å°¾ã€‚

MBR æœ¬èº«ä¹Ÿæ˜¯ç¨‹åºï¼Œæ˜¯ç¨‹åºå°±è¦ç”¨åˆ°æ ˆï¼Œæ ˆä¹Ÿæ˜¯åœ¨å†…å­˜ä¸­çš„ï¼Œè™½ç„¶ MBR æœ¬èº«åªæœ‰ 512 å­—èŠ‚ï¼Œä½†è¿˜è¦ä¸ºå…¶æ‰€ç”¨çš„æ ˆåˆ†é…ç‚¹ç©ºé—´ï¼Œæ‰€ä»¥å…¶å®é™…æ‰€ç”¨çš„å†…å­˜ç©ºé—´è¦å¤§äº 512 å­—èŠ‚ï¼Œä¼°è®¡ 1KB å†…å­˜å¤Ÿç”¨äº†ã€‚

ç»“åˆä»¥ä¸Šå‡ ç‚¹ï¼Œé€‰æ‹© 32KB ä¸­çš„æœ€å 1KB æœ€ä¸ºåˆé€‚ã€‚32KB è½¬æ¢ä¸ºåå…­è¿›åˆ¶æ˜¯ 0x8000ï¼Œå‡å» 1KB (0x0400) çš„è¯ï¼Œæ­£å¥½ç­‰äº 0x7c00ã€‚è¿™å°±æ˜¯å¤‡å—è´¨ç–‘çš„ 0x7c00 çš„ç”±æ¥ï¼

### å®ç°ä¸€ä¸ªç®€å•çš„ MBR

æœ€åï¼Œè®©æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬æ‰€å­¦åˆ°çš„ç†è®ºçŸ¥è¯†çš„æ­£ç¡®æ€§ã€‚

é¡¹ç›®ç»“æ„ä¸ºï¼š

```plaintext
.
â”œâ”€â”€ boot
â”‚Â Â  â”œâ”€â”€ link.ld
â”‚Â Â  â””â”€â”€ mbr.s
â””â”€â”€ Makefile

```

```asm title="boot/mbr.asm" wrap=false
.code16
.section .text
.global _main

_main:
  mov %cs, %ax
  mov %ax, %ss
  mov %ax, %sp
  mov $0xb800, %ax
  mov %ax, %es

  mov $0x0600, %ax # clear screen
  mov $0x07, %bh   # color attribute 0x07
  xor %cx, %cx     # upper left corner
  mov $0x184f, %dx # bottom right corner
  int $0x10

  movb $'M', %es:[0x00]
  movb $0x07, %es:[0x01]
  movb $'B', %es:[0x02]
  movb $0x07, %es:[0x03]
  movb $'R', %es:[0x04]
  movb $0x07, %es:[0x05]

  jmp .
```

ä»¥ä¸Šï¼Œæœ‰å…³ `int 0x10` è§†é¢‘ä¸­æ–­çš„ç”¨æ³•å¯ä»¥å‚è€ƒ [INT 10 - Video BIOS Services](https://stanislavs.org/helppc/int_10.html).

è¿™é‡Œæˆ‘ä¸å¾—ä¸åæ§½ä¸€å¥ï¼šAT&T è¯­æ³•çå°¼ ğŸ´ å±â€¦â€¦

æ›´æœ‰è¶£çš„æ˜¯ï¼š

> Intel Syntax Support
>
> Up until v2.10 of binutils, GAS supported only the AT&T syntax for x86 and x86-64, which differs significantly from the Intel syntax used by virtually every other assembler. Today, GAS supports both syntax sets (.intel_syntax and the default .att_syntax), and even allows disabling the otherwise mandatory operand prefixes '%' or '$' (...\_syntax noprefix). There are some pitfalls - several FP opcodes suffer from a reverse operand ordering that is bound to stay in there for compatibility reasons, .intel_syntax generates less optimized opcodes on occasion (try mov'ing to %si...).
>
> It is generally discouraged to use the support for Intel Syntax because it can subtly and surprisingly different than the real Intel Syntax found in other assemblers. A different assembler should be considered if Intel Syntax is desired.

å”‰ç®—äº†ï¼Œå¿å¿å°±è¿‡å»äº†â€¦â€¦

éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘å¹¶æ²¡æœ‰å°†æœ€åçš„ magic number è®¾ç½®å†™åœ¨ `mbr.asm` ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ä¸‹é¢çš„ `link.ld` æ¥å®ç°ï¼š

```plaintext title="boot/link.ld" wrap=false
OUTPUT_FORMAT(binary)
ENTRY(_main)
SECTIONS
{
  /* The BIOS loads the code from the disk to this location. We must tell
   * that to the linker so that it can properly calculate the addresses of
   * the symbols we might jump to.
   */
  . = 0x7c00;
  .text :
  {
    _main = .;
    *(.text)
    /* Place the magic bytes at the end of the first 512 bytes sector. */
    . = 0x1FE;
    SHORT(0xAA55);
  }
}
```

```plaintext title="Makefile" wrap=false
AS = i386-elf-as
LD = i386-elf-ld

boot/mbr: boot/mbr.o
 $(LD) -T boot/link.ld -o $@ $<

boot/mbr.o: boot/mbr.s
 $(AS) -o $@ $<

clean:
 rm -rf boot/mbr
 rm -rf boot/*.o
```

é€šè¿‡ `qemu-img create -f raw hd60M.img 60M` åˆ›å»ºä¸€ä¸ªç¡¬ç›˜é•œåƒï¼Œä½¿ç”¨ `make` æ¥è‡ªåŠ¨ç¼–è¯‘ä¸Šè¿°ç¨‹åºï¼Œæœ€åï¼Œé€šè¿‡ `dd if=boot/mbr of=hd60M.img bs=512 count=1 conv=notrunc` å°†æˆ‘ä»¬ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºå†™å…¥ç¡¬ç›˜é•œåƒçš„ 0 ç›˜ 0 é“ 1 æ‰‡åŒºã€‚

æœ€ç»ˆï¼Œé€šè¿‡ `qemu-system-i386 -drive file=hd60M.img,format=raw -s -S` å¯åŠ¨è™šæ‹Ÿæœºï¼Œä¹‹åä½ å°±å¯ä»¥é€šè¿‡ `gdb`ï¼Œä½¿ç”¨ `target remote localhost:1234` è¿æ¥åˆ°è™šæ‹Ÿæœºè¿›è¡Œè°ƒè¯•äº†ï¼Œç›´æ¥ `(c) continue`ï¼Œçœ‹åˆ° MBR ä¸‰ä¸ªå¤§å­—è¢«è¾“å‡ºåœ¨å±å¹•ä¸Šï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æˆåŠŸåœ°å‘ MBR è¿ˆå‡ºäº†ç¬¬ä¸€æ­¥ï¼Œå£®ä¸¾ï¼

> [!TIP]
> å¦‚æœä½ é€šè¿‡ gdb æŸ¥çœ‹å¼€æœºåè¿è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œä¼šå‘ç°è¿™æ¡æŒ‡ä»¤å¹¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œè¿™å¯èƒ½æ˜¯å› ä¸º gdb è§£æçš„æ˜¯ 32-bit æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯ 16-bit æŒ‡ä»¤ã€‚
>
> æ‰€ä»¥å¦‚æœä½ æƒ³æŸ¥çœ‹å¼€æœºåè¿è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„è¯ï¼Œå¯ä»¥åœ¨å¯åŠ¨è™šæ‹Ÿæœºçš„æŒ‡ä»¤åé¢åŠ ä¸Š `-monitor stdio` å‚æ•°ï¼Œä¹‹ååœ¨ qemu æ§åˆ¶å°ä½¿ç”¨ `x/10i $cs*16+$eip` æŒ‡ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹ã€‚
>
> ç»“æœå¦‚ä¸‹ï¼š
>
> ```asm showLineNumbers=false wrap=false ins={2}
> (qemu) x/10i $cs*16+$eip
> 0x000ffff0:  ea 5b e0 00 f0           ljmpw    $0xf000:$0xe05b
> 0x000ffff5:  30 36 2f 32              xorb     %dh, 0x322f
> 0x000ffff9:  33 2f                    xorw     (%bx), %bp
> 0x000ffffb:  39 39                    cmpw     %di, (%bx, %di)
> 0x000ffffd:  00 fc                    addb     %bh, %ah
> 0x000fffff:  00 00                    addb     %al, (%bx, %si)
> 0x00100001:  00 00                    addb     %al, (%bx, %si)
> 0x00100003:  00 00                    addb     %al, (%bx, %si)
> 0x00100005:  00 00                    addb     %al, (%bx, %si)
> 0x00100007:  00 00                    addb     %al, (%bx, %si)
> ```

# å¼€å‘æ—¥å¿—

Yeeee! ä»Šå¤©ï¼Œ03/12/2025ï¼Œæˆ‘ç»ˆäºæ­£å¼å†™ä¸‹äº† Exordium çš„ç¬¬ä¸€è¡Œä»£ç <s>ï¼ˆå…¶å®æ˜¯å¥½å‡ è¡Œâ€¦â€¦ï¼‰</s>ã€‚ä»æ­¤ï¼Œæ¥åŠ›æ£’ç”± BIOS ä¼ åˆ°äº† MBR ä¹‹æ‰‹ï¼ŒçœŸæ˜¯å€¼å¾—åº†ç¥çš„ä¸€åˆ»å‘¢ï¼

# ä¹¦ä¸­çš„å‹˜è¯¯

åŸºäº **_ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹ï¼ˆ2022.10 é‡å°ï¼‰_**ã€‚

è™½ç„¶å¯èƒ½é”™çš„æ˜¯æˆ‘ï¼Œä½†å¹¶ä¸å¦¨ç¢æˆ‘å†™å‡ºæ¥ã€‚æ¬¢è¿ä¸€èµ·è®¨è®ºï½

## ç¬¬ 0 ç« ï¼šä¸€äº›ä½ å¯èƒ½æ­£æ„Ÿåˆ°è¿·æƒ‘çš„é—®é¢˜

- **0.2 ä½ æƒ³ç ”ç©¶åˆ°ä»€ä¹ˆç¨‹åº¦**

ä¸‰å¤„ $$4\times 4\times 4$$ åº”ä¿®æ”¹ä¸º $$4+4+4$$ã€‚

- **0.15 å±€éƒ¨å˜é‡å’Œå‡½æ•°å‚æ•°ä¸ºä»€ä¹ˆè¦æ”¾åœ¨æ ˆä¸­**

> æ ˆç”±äºæ˜¯å‘ä¸‹ç”Ÿé•¿çš„ï¼Œå †æ ˆæ¡†æ¶å°±æ˜¯æŠŠ esp æŒ‡é’ˆæå‰åŠ ä¸€ä¸ªæ•°ï¼ŒåŸ esp æŒ‡é’ˆåˆ°æ–° esp æŒ‡é’ˆä¹‹é—´çš„æ ˆç©ºé—´ç”¨æ¥å­˜å‚¨å±€éƒ¨å˜é‡ã€‚

è¿™é‡Œåº”è¯¥è¯´æ˜¯æå‰å‡ä¸€ä¸ªæ•°æ‰å¯¹ï¼Œå› ä¸ºæ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿çš„ï¼Œæ‰€ä»¥åˆ›å»ºæ ˆå¸§æ˜¯å‡ï¼Œæ¸…ç†æ‰æ˜¯åŠ ã€‚

## ç¬¬ 1 ç« ï¼šéƒ¨ç½²å·¥ä½œç¯å¢ƒ

- **1.3 æ“ä½œç³»ç»Ÿçš„å®¿ä¸»ç¯å¢ƒ**

> åœ¨ç¼–è¯‘ä¸­è¦åŠ  -lpthread å‚æ•°ã€‚ç”¨ vim ç¼–è¯‘ makefileï¼Œvim æ˜¯ Linux ä¸‹åŠŸèƒ½æœ€ä¸ºå¼ºå¤§çš„æ–‡æœ¬ç¼–è¾‘å™¨ã€‚vim Makefile å›è½¦ï¼š

æ­¤å¤„æœ‰ä¸ªå°å°çš„ typoï¼šã€Œç”¨ vim ç¼–è¯‘ makefileã€åº”æ”¹ä¸ºã€Œç”¨ vim ç¼–è¾‘ makefileã€ã€‚

## ç¬¬ 2 ç« ï¼šç¼–å†™ MBR ä¸»å¼•å¯¼è®°å½•ï¼Œè®©æˆ‘ä»¬å¼€å§‹æŒæƒ

- **2.2 è½¯ä»¶æ¥åŠ›ç¬¬ä¸€æ£’ï¼ŒBIOS**

è¿™é‡Œå­˜åœ¨ä¸€ä¸ªè¡¨æ ¼å†…éƒ¨çš„ typoï¼ŒåŸè¡¨æ ¼å¦‚ä¸‹ï¼š

| èµ·å§‹  | ç»“æŸ  | å¤§å° | ç”¨é€”                                                                                                                                              |
| ----- | ----- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| FFFF0 | FFFFF | 16B  | BIOS å…¥å£åœ°å€ï¼Œæ­¤åœ°å€ä¹Ÿå±äº BIOS ä»£ç ï¼ŒåŒæ ·å±äºé¡¶éƒ¨çš„ 640KB å­—èŠ‚ã€‚åªæ˜¯ä¸ºäº†å¼ºè°ƒå…¶å…¥å£åœ°å€æ‰å•ç‹¬è´´å‡ºæ¥ã€‚æ­¤å¤„ 16 å­—èŠ‚çš„å†…å®¹æ˜¯è·³è½¬æŒ‡ä»¤ jmp F000\:E05B |

ä¿®æ”¹ä¸ºå±äºé¡¶éƒ¨çš„ 64KB å­—èŠ‚è€Œä¸æ˜¯ 640KBï¼š

| èµ·å§‹  | ç»“æŸ  | å¤§å° | ç”¨é€”                                                                                                                                             |
| ----- | ----- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| FFFF0 | FFFFF | 16B  | BIOS å…¥å£åœ°å€ï¼Œæ­¤åœ°å€ä¹Ÿå±äº BIOS ä»£ç ï¼ŒåŒæ ·å±äºé¡¶éƒ¨çš„ 64KB å­—èŠ‚ã€‚åªæ˜¯ä¸ºäº†å¼ºè°ƒå…¶å…¥å£åœ°å€æ‰å•ç‹¬è´´å‡ºæ¥ã€‚æ­¤å¤„ 16 å­—èŠ‚çš„å†…å®¹æ˜¯è·³è½¬æŒ‡ä»¤ jmp F000\:E05B |

## ç¬¬ 3 ç« ï¼šå®Œå–„ MBR

- **3.1.3 ä»€ä¹ˆæ˜¯ vstart**

ä¸¤å¤„ã€Œcode.èŠ‚å.startã€åº”ä¿®æ”¹ä¸ºã€Œsection.èŠ‚å.startã€ã€‚

- **3.2.2 å®æ¨¡å¼ä¸‹çš„å¯„å­˜å™¨**

è¿˜æ˜¯ typoï¼šã€ŒIP å¯„å­˜å™¨æ˜¯ä¸å¯è§å¯„å­˜å™¨ï¼ŒCS å¯„å­˜å™¨æ˜¯å¯è§å¯„å­˜å™¨ã€‚è¿™ä¸¤ä¸ªé…åˆåœ¨ä¸€èµ·åå°±æ˜¯ CPU çš„ç½—ç›˜ï¼Œå®ƒä»¬æ˜¯ç»™ CPU å¯¼èˆªç”¨çš„ã€‚CPU æ‰§è¡Œåˆ°ä½•å¤„ï¼Œå®Œæˆè¦å¬ä»è¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å®‰æ’ã€‚ã€ï¼Œã€Œå®Œæˆã€åº”æ”¹æˆã€Œå®Œå…¨ã€ã€‚

- **3.2.4 å®æ¨¡å¼ä¸‹ CPU å†…å­˜å¯»å€æ–¹å¼**

ç›´æ¥å¯»å€è¿™é‡Œï¼Œã€Œç¬¬äºŒæ¡æŒ‡ä»¤ä¸­ï¼Œç”±äºä½¿ç”¨äº†æ®µè·¨è¶Šå‰ç¼€ fsï¼Œ0x5678 çš„æ®µåŸºå€å˜æˆäº† gs å¯„å­˜å™¨ã€‚ã€è¿™é‡Œä¸åº”è¯¥æ˜¯ gs å¯„å­˜å™¨ï¼Œè€Œæ˜¯ fs å¯„å­˜å™¨æ‰å¯¹ã€‚

- **3.2.7 å®æ¨¡å¼ä¸‹çš„ call - 16 ä½å®æ¨¡å¼ç›¸å¯¹è¿‘è°ƒç”¨**

ã€ŒæŒ‡ä»¤ä¸­çš„ç«‹å³æ•°åœ°å€å¯ä»¥æ˜¯è¢«è°ƒç”¨çš„å‡½æ•°åã€æ ‡å·ã€ç«‹å³æ•°ï¼Œå‡½æ•°ååŒæ ‡å·ä¸€æ ·ï¼Œå®ƒåªæ˜¯åœ°å€çš„äººæ€§åŒ–è¡¨ç¤ºæ–¹æ³•ï¼Œæœ€ç»ˆä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºä¸€ä¸ªå®é™…æ•°å­—åœ°å€ï¼Œå¦‚ call near prog_nameã€‚ã€è¿™é‡Œã€Œprog_nameã€åº”æ”¹ä¸ºåŒä¸‹æ–‡ä¸€æ ·çš„ã€Œproc_nameã€ï¼Œè¦ä¹ˆå°±å…¨éƒ¨æ”¹æˆã€Œprog_nameã€ã€‚å…¶å®æˆ‘æ›´åå‘äºã€Œprog_nameã€ï¼Œå› ä¸ºã€Œprocã€é€šå¸¸ç¼©å†™ä¸ºè¿›ç¨‹ (process) çš„æƒ…å†µæ›´å¸¸è§ï¼Œæ•…æˆ‘è§‰å¾—æ”¹æˆã€Œprog_nameã€ç›¸å¯¹æ¥è¯´æ¯”è¾ƒåˆé€‚ï¼Œä½†æ˜¯ä¹¦ä¸Šä½œè€…å‡ ä¹æ‰€æœ‰åœ°æ–¹éƒ½åœ¨ç”¨ã€Œproc_nameã€æ¥å‘½åï¼Œæˆ‘ä¸çŸ¥é“è¿™æ˜¯è€ƒè™‘åˆ°äº†ä»€ä¹ˆåŸå› æ‰è¿™æ ·å‘½åï¼Œè¿˜æ˜¯å®Œå…¨åªæ˜¯ä¸ªé”™è¯¯æˆ‘ä¹Ÿä¸æ¸…æ¥šï¼Œæ•…åœ¨æ­¤åªç•™ä¸‹ä¸€ç‚¹ä¸ªäººçš„æ‹™è§ã€‚

ã€Œè¿™å¥½åŠï¼Œå’±ä»¬ä¸Š bochs çœ‹ï¼Œè®©å…¶è¾¹æ‰§è¡Œè¾¹åæ±‡ç¼–ç»™å’±ä»¬çœ‹ç»“æœã€‚ä¸‹é¢ç²—ä½“çš„æ–‡ä»¶æ˜¯æˆ‘åŠ çš„æ³¨é‡Šè¯´æ˜ã€‚ã€è¿™é‡Œã€Œæ–‡ä»¶ã€åº”è¯¥æ”¹æˆã€Œæ–‡å­—ã€å§ã€‚æ”¹æˆã€Œæ–‡å­—ã€çš„è¯ï¼Œæ’ç‰ˆä¸Šä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºè´´å‡ºæ¥çš„é¢å¤–æ³¨é‡Šå­—ä½“å¹¶ä¸æ˜¯å‘ˆç²—ä½“çš„ã€‚è¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯ï¼Œä½œè€…å°† `> (markdown cite syntax)` å¼•ç”¨æ ¼å¼çš„æ’ç‰ˆæè¿°ä¸ºç²—ä½“ï¼Œå°†å¼•ç”¨å†…å®¹æè¿°æˆæ–‡ä»¶ï¼Œä¸è¿‡è¿™æ ·ç†è§£çš„è¯ä¹Ÿä¼šå¼•å‡ºä¸€ä¸ªäº‰ç«¯ï¼šå¼•ç”¨çš„å†…å®¹ç§°ä¸ºã€Œæ–‡ä»¶ã€å¹¶ä¸åˆé€‚ï¼Œå¦‚æœä¸€å®šè¦ç”¨ã€Œæ–‡ä»¶ã€è¿™ä¸ªè¯è¯­çš„è¯ï¼Œæˆ‘è§‰å¾—å†™æˆã€Œæ–‡ä»¶å†…å®¹ã€æ›´å¥½ã€‚

- **3.3.1 CPU å¦‚ä½•ä¸å¤–ç•Œè®¾å¤‡é€šä¿¡â€”â€”IO æ¥å£**

ã€Œå†è¯´ï¼ŒåŒä»»ä½•ä¸€ä¸ªè®¾å¤‡æ‰“äº¤é“ï¼ŒCPU é‚£ä¹ˆé€Ÿåº¦é‚£ä¹ˆå¿«ï¼Œå®ƒä¸å¾—å«Œå¼ƒåˆ«äººæ…¢å—â€¦â€¦ã€å¤šæ‰“äº†ä¸€ä¸ªã€Œé‚£ä¹ˆã€ã€‚
